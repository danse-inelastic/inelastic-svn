<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>graphics: graphics/StringFunction.py Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.5.1 -->
<div class="tabs">
  <ul>
    <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
    <li><a href="namespaces.html"><span>Packages</span></a></li>
    <li><a href="classes.html"><span>Classes</span></a></li>
    <li id="current"><a href="files.html"><span>Files</span></a></li>
    <li><a href="dirs.html"><span>Directories</span></a></li>
  </ul></div>
<div class="tabs">
  <ul>
    <li><a href="files.html"><span>File&nbsp;List</span></a></li>
    <li><a href="globals.html"><span>File&nbsp;Members</span></a></li>
  </ul></div>
<div class="nav">
<a class="el" href="dir_dc27557eb50c9a5c2577a405955536a2.html">graphics</a></div>
<h1>StringFunction.py</h1><a href="StringFunction_8py.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a><a class="code" href="namespacegraphics_1_1StringFunction.html">00001</a> <span class="comment">#!/usr/bin/env python</span>
<a name="l00002"></a>00002 <span class="stringliteral">"""Make a string with a mathematical expression behave as a Python function."""</span>
<a name="l00003"></a>00003 
<a name="l00004"></a>00004 <span class="comment"># Default import of mathematical functions (in case the user</span>
<a name="l00005"></a>00005 <span class="comment"># supplies expressions with math functions and does not provide</span>
<a name="l00006"></a>00006 <span class="comment"># a globals keyword to the constructor with appropriate modules</span>
<a name="l00007"></a>00007 <span class="comment"># defining these math functions):</span>
<a name="l00008"></a>00008 <span class="comment"># from math import *</span>
<a name="l00009"></a>00009 math_functions = [<span class="stringliteral">'acos'</span>, <span class="stringliteral">'asin'</span>, <span class="stringliteral">'atan'</span>, <span class="stringliteral">'atan2'</span>, <span class="stringliteral">'ceil'</span>, <span class="stringliteral">'cos'</span>,
<a name="l00010"></a>00010                   <span class="stringliteral">'cosh'</span>, <span class="stringliteral">'exp'</span>, <span class="stringliteral">'fabs'</span>, <span class="stringliteral">'floor'</span>, <span class="stringliteral">'log'</span>, <span class="stringliteral">'log10'</span>,
<a name="l00011"></a>00011                   <span class="stringliteral">'pi'</span>, <span class="stringliteral">'pow'</span>, <span class="stringliteral">'sin'</span>, <span class="stringliteral">'sinh'</span>, <span class="stringliteral">'sqrt'</span>, <span class="stringliteral">'tan'</span>, <span class="stringliteral">'tanh'</span>]
<a name="l00012"></a>00012 s = <span class="stringliteral">'from math import '</span> + <span class="stringliteral">', '</span>.join(math_functions)
<a name="l00013"></a>00013 exec s
<a name="l00014"></a>00014 <span class="comment"># Problem: vectorized expressions require NumPy versions</span>
<a name="l00015"></a>00015 <span class="comment"># (Numeric, numarray, scipy) of the math functions. We try to</span>
<a name="l00016"></a>00016 <span class="comment"># detect errors arising from such lacking imports.</span>
<a name="l00017"></a>00017 
<a name="l00018"></a>00018 <span class="comment"># The first edition of the "Python for Computational Science" book</span>
<a name="l00019"></a>00019 <span class="comment"># introduced the classes StringFunction1x, StringFunction1, and</span>
<a name="l00020"></a>00020 <span class="comment"># StringFunction. These are now (for the second edition) named</span>
<a name="l00021"></a>00021 <span class="comment"># StringFunction_v3, StringFunction_v4, and StringFunction_v5,</span>
<a name="l00022"></a>00022 <span class="comment"># respectively.</span>
<a name="l00023"></a>00023 
<a name="l00024"></a>00024 
<a name="l00025"></a>00025 <span class="comment"># The following implementation of StringFunction is an</span>
<a name="l00026"></a>00026 <span class="comment"># improved version compared to the one explained in the</span>
<a name="l00027"></a>00027 <span class="comment"># first printing of the book "Python for Computational Science".</span>
<a name="l00028"></a>00028 <span class="comment"># The new version is created by Mario Pernici &lt;Mario.Pernici@mi.infn.it&gt;</span>
<a name="l00029"></a>00029 <span class="comment"># and Hans Petter Langtangen &lt;hpl@ifi.uio.no&gt;. The basic idea is to</span>
<a name="l00030"></a>00030 <span class="comment"># build a lambda function out of the string expression and define</span>
<a name="l00031"></a>00031 <span class="comment"># self.__call__ to be this lambda function.</span>
<a name="l00032"></a>00032 
<a name="l00033"></a><a class="code" href="classgraphics_1_1StringFunction_1_1StringFunction.html">00033</a> <span class="keyword">class </span><a class="code" href="classgraphics_1_1StringFunction_1_1StringFunction.html">StringFunction</a>:
<a name="l00034"></a>00034     <span class="stringliteral">"""</span>
<a name="l00035"></a><a class="code" href="classgraphics_1_1StringFunction_1_1StringFunction.html#681c153bfcb3010c2570e6050293d661">00035</a> <span class="stringliteral">    Representation of a string formula as a function of one or</span>
<a name="l00036"></a><a class="code" href="classgraphics_1_1StringFunction_1_1StringFunction.html#2e5f39be10d845ce0d915d994a05dd10">00036</a> <span class="stringliteral">    more variables, optionally with parameters.</span>
<a name="l00037"></a>00037 <span class="stringliteral"></span>
<a name="l00038"></a>00038 <span class="stringliteral">    Example on usage:</span>
<a name="l00039"></a><a class="code" href="classgraphics_1_1StringFunction_1_1StringFunction.html#002a0b53d40f89646abd7e1dd94898bb">00039</a> <span class="stringliteral"></span>
<a name="l00040"></a>00040 <span class="stringliteral">    &gt;&gt;&gt; from graphics.StringFunction import StringFunction</span>
<a name="l00041"></a>00041 <span class="stringliteral">    &gt;&gt;&gt; f = StringFunction('1+sin(2*x)')</span>
<a name="l00042"></a>00042 <span class="stringliteral">    &gt;&gt;&gt; f(1.2)</span>
<a name="l00043"></a>00043 <span class="stringliteral">    1.6754631805511511</span>
<a name="l00044"></a>00044 <span class="stringliteral"></span>
<a name="l00045"></a>00045 <span class="stringliteral">    &gt;&gt;&gt; f = StringFunction('1+sin(2*t)', independent_variables='t')</span>
<a name="l00046"></a>00046 <span class="stringliteral">    &gt;&gt;&gt; f(1.2)</span>
<a name="l00047"></a>00047 <span class="stringliteral">    1.6754631805511511</span>
<a name="l00048"></a>00048 <span class="stringliteral"></span>
<a name="l00049"></a>00049 <span class="stringliteral">    &gt;&gt;&gt; f = StringFunction('1+A*sin(w*t)', independent_variables='t', \</span>
<a name="l00050"></a>00050 <span class="stringliteral">                           A=0.1, w=3.14159)</span>
<a name="l00051"></a>00051 <span class="stringliteral">    &gt;&gt;&gt; f(1.2)</span>
<a name="l00052"></a>00052 <span class="stringliteral">    0.94122173238695939</span>
<a name="l00053"></a>00053 <span class="stringliteral">    &gt;&gt;&gt; f.set_parameters(A=1, w=1)</span>
<a name="l00054"></a>00054 <span class="stringliteral">    &gt;&gt;&gt; f(1.2)</span>
<a name="l00055"></a>00055 <span class="stringliteral">    1.9320390859672263</span>
<a name="l00056"></a>00056 <span class="stringliteral"></span>
<a name="l00057"></a>00057 <span class="stringliteral">    &gt;&gt;&gt; f(1.2, A=2, w=1)   # can also set parameters in the call</span>
<a name="l00058"></a>00058 <span class="stringliteral">    2.8640781719344526</span>
<a name="l00059"></a>00059 <span class="stringliteral"></span>
<a name="l00060"></a><a class="code" href="classgraphics_1_1StringFunction_1_1StringFunction.html#54d1fafb7d88a7333a3662319c9ce184">00060</a> <span class="stringliteral">    &gt;&gt;&gt; # function of two variables:</span>
<a name="l00061"></a>00061 <span class="stringliteral">    &gt;&gt;&gt; f = StringFunction('1+sin(2*x)*cos(y)', \</span>
<a name="l00062"></a>00062 <span class="stringliteral">                           independent_variables=('x','y'))</span>
<a name="l00063"></a>00063 <span class="stringliteral">    &gt;&gt;&gt; f(1.2,-1.1)</span>
<a name="l00064"></a>00064 <span class="stringliteral">    1.3063874788637866</span>
<a name="l00065"></a>00065 <span class="stringliteral"></span>
<a name="l00066"></a>00066 <span class="stringliteral">    &gt;&gt;&gt; f = StringFunction('1+V*sin(w*x)*exp(-b*t)', \</span>
<a name="l00067"></a>00067 <span class="stringliteral">                           independent_variables=('x','t'))</span>
<a name="l00068"></a>00068 <span class="stringliteral">    &gt;&gt;&gt; f.set_parameters(V=0.1, w=1, b=0.1)</span>
<a name="l00069"></a>00069 <span class="stringliteral">    &gt;&gt;&gt; f(1.0,0.1)</span>
<a name="l00070"></a>00070 <span class="stringliteral">    1.0833098208613807</span>
<a name="l00071"></a>00071 <span class="stringliteral">    &gt;&gt;&gt; str(f)  # print formula with parameters substituted by values</span>
<a name="l00072"></a>00072 <span class="stringliteral">    '1+0.1*sin(1*x)*exp(-0.1*t)'</span>
<a name="l00073"></a>00073 <span class="stringliteral">    &gt;&gt;&gt; repr(f)</span>
<a name="l00074"></a><a class="code" href="classgraphics_1_1StringFunction_1_1StringFunction.html#68d8fc8865c700ee04c22bb7d1c6e38e">00074</a> <span class="stringliteral">    "StringFunction('1+V*sin(w*x)*exp(-b*t)', independent_variables=('x', 't'), b=0.10000000000000001, w=1, V=0.10000000000000001)"</span>
<a name="l00075"></a>00075 <span class="stringliteral">    </span>
<a name="l00076"></a><a class="code" href="classgraphics_1_1StringFunction_1_1StringFunction.html#447afcb4d7c34d8f8ada51c01489e84b">00076</a> <span class="stringliteral">    &gt;&gt;&gt; # vector field of x and y:</span>
<a name="l00077"></a>00077 <span class="stringliteral">    &gt;&gt;&gt; f = StringFunction('[a+b*x,y]', \</span>
<a name="l00078"></a>00078 <span class="stringliteral">                           independent_variables=('x','y'))</span>
<a name="l00079"></a>00079 <span class="stringliteral">    &gt;&gt;&gt; f.set_parameters(a=1, b=2)</span>
<a name="l00080"></a>00080 <span class="stringliteral">    &gt;&gt;&gt; f(2,1)  # [1+2*2, 1]</span>
<a name="l00081"></a>00081 <span class="stringliteral">    [5, 1]</span>
<a name="l00082"></a>00082 <span class="stringliteral"></span>
<a name="l00083"></a>00083 <span class="stringliteral">    Troubleshooting:</span>
<a name="l00084"></a>00084 <span class="stringliteral"></span>
<a name="l00085"></a>00085 <span class="stringliteral">    1)</span>
<a name="l00086"></a>00086 <span class="stringliteral">    The StringFunction class can work with sin, cos, exp, and other</span>
<a name="l00087"></a>00087 <span class="stringliteral">    mathematical functions if the argument is a scalar (float or int) type.</span>
<a name="l00088"></a><a class="code" href="classgraphics_1_1StringFunction_1_1StringFunction.html#1ffe4216411ef8495e13261d56459eaa">00088</a> <span class="stringliteral">    If the argument is a vector, the NumPy (or SciPy) versions of sin, cos,</span>
<a name="l00089"></a>00089 <span class="stringliteral">    exp, etc., are needed. A common error message in the latter case is</span>
<a name="l00090"></a>00090 <span class="stringliteral"></span>
<a name="l00091"></a>00091 <span class="stringliteral">    TypeError: only rank-0 arrays can be converted to Python scalars.</span>
<a name="l00092"></a><a class="code" href="classgraphics_1_1StringFunction_1_1StringFunction.html#1a3f542182bb70accfcd7626eb2bb1a4">00092</a> <span class="stringliteral"></span>
<a name="l00093"></a>00093 <span class="stringliteral">    Make something like</span>
<a name="l00094"></a>00094 <span class="stringliteral"></span>
<a name="l00095"></a>00095 <span class="stringliteral">    from numarray import *</span>
<a name="l00096"></a>00096 <span class="stringliteral">    # or (better)</span>
<a name="l00097"></a>00097 <span class="stringliteral">    from numarray import sin, cos</span>
<a name="l00098"></a>00098 <span class="stringliteral"></span>
<a name="l00099"></a>00099 <span class="stringliteral">    in the calling code and supply globals=globals() as argument to</span>
<a name="l00100"></a>00100 <span class="stringliteral">    the constructor:</span>
<a name="l00101"></a>00101 <span class="stringliteral">    f = StringFunction('1+x*y', globals=globals())</span>
<a name="l00102"></a>00102 <span class="stringliteral">    f(p,q) will now work for NumPy arrays p and q.</span>
<a name="l00103"></a>00103 <span class="stringliteral"></span>
<a name="l00104"></a>00104 <span class="stringliteral">    2)</span>
<a name="l00105"></a>00105 <span class="stringliteral">    At present, you cannot send StringFunction instances to Fortran</span>
<a name="l00106"></a>00106 <span class="stringliteral">    if F2PY generated the wrapper code. The workaround is to send</span>
<a name="l00107"></a>00107 <span class="stringliteral">    the __call__ function, e.g.,</span>
<a name="l00108"></a>00108 <span class="stringliteral">    f = StringFunction(...)</span>
<a name="l00109"></a>00109 <span class="stringliteral">    v = my_f77_routine(f.__call__)</span>
<a name="l00110"></a>00110 <span class="stringliteral">    </span>
<a name="l00111"></a>00111 <span class="stringliteral">    """</span>
<a name="l00112"></a>00112     <span class="keyword">def </span><a class="code" href="classgraphics_1_1StringFunction_1_1StringFunction.html#681c153bfcb3010c2570e6050293d661">__init__</a>(self, expression, **kwargs):
<a name="l00113"></a>00113         self.<a class="code" href="classgraphics_1_1StringFunction_1_1StringFunction.html#2e5f39be10d845ce0d915d994a05dd10">_f</a>_f = expression
<a name="l00114"></a>00114         <span class="comment"># self._var holds the independent variables in a tuple:</span>
<a name="l00115"></a>00115         <span class="keywordflow">if</span> <span class="stringliteral">'independent_variable'</span> <span class="keywordflow">in</span> kwargs:
<a name="l00116"></a>00116             self.<a class="code" href="classgraphics_1_1StringFunction_1_1StringFunction.html#002a0b53d40f89646abd7e1dd94898bb">_var</a>_var = tuple(kwargs[<span class="stringliteral">'independent_variable'</span>])  <span class="comment"># 'x', 't' etc.</span>
<a name="l00117"></a>00117         <span class="keywordflow">else</span>:
<a name="l00118"></a>00118             self.<a class="code" href="classgraphics_1_1StringFunction_1_1StringFunction.html#002a0b53d40f89646abd7e1dd94898bb">_var</a>_var = tuple(kwargs.get(<span class="stringliteral">'independent_variables'</span>, (<span class="stringliteral">'x'</span>,)))
<a name="l00119"></a>00119         <span class="comment"># user's globals() array (with relevant imported modules/functions):</span>
<a name="l00120"></a>00120         self._globals = kwargs.get(<span class="stringliteral">'globals'</span>, globals())
<a name="l00121"></a>00121 
<a name="l00122"></a>00122         self.__name__ = self.<a class="code" href="classgraphics_1_1StringFunction_1_1StringFunction.html#2e5f39be10d845ce0d915d994a05dd10">_f</a>_f  <span class="comment"># class name = function expression</span>
<a name="l00123"></a>00123         self._prms = kwargs.copy()
<a name="l00124"></a>00124         <span class="keywordflow">try</span>:    del self._prms[<span class="stringliteral">'independent_variable'</span>]
<a name="l00125"></a>00125         <span class="keywordflow">except</span>: <span class="keywordflow">pass</span>
<a name="l00126"></a>00126         <span class="keywordflow">try</span>:    del self._prms[<span class="stringliteral">'independent_variables'</span>]
<a name="l00127"></a>00127         <span class="keywordflow">except</span>: <span class="keywordflow">pass</span>
<a name="l00128"></a>00128         <span class="keywordflow">try</span>:    del self._prms[<span class="stringliteral">'globals'</span>]
<a name="l00129"></a>00129         <span class="keywordflow">except</span>: <span class="keywordflow">pass</span>
<a name="l00130"></a>00130         <span class="keywordflow">try</span>:
<a name="l00131"></a>00131             <span class="comment"># may fail if not all parameters are defined yet</span>
<a name="l00132"></a>00132             self.<a class="code" href="classgraphics_1_1StringFunction_1_1StringFunction.html#54d1fafb7d88a7333a3662319c9ce184">_build_lambda</a>_build_lambda()
<a name="l00133"></a><a class="code" href="classgraphics_1_1StringFunction_1_1StringFunction.html#390659207cf3f80216f3a2e2938751ed">00133</a>         <span class="keywordflow">except</span> NameError, e:
<a name="l00134"></a>00134             <span class="comment">#print e</span>
<a name="l00135"></a>00135             <span class="keywordflow">pass</span> <span class="comment"># ok at this stage: parameters might be missing</span>
<a name="l00136"></a>00136 
<a name="l00137"></a>00137     <span class="keyword">def </span><a class="code" href="classgraphics_1_1StringFunction_1_1StringFunction.html#54d1fafb7d88a7333a3662319c9ce184">_build_lambda</a>(self):
<a name="l00138"></a>00138         <span class="stringliteral">"""</span>
<a name="l00139"></a>00139 <span class="stringliteral">        Translate the expression to a lambda function taking the</span>
<a name="l00140"></a>00140 <span class="stringliteral">        independent variables as positional arguments and the</span>
<a name="l00141"></a>00141 <span class="stringliteral">        parameters as keyword arguments.</span>
<a name="l00142"></a>00142 <span class="stringliteral">        The idea is due to Mario Pernici &lt;Mario.Pernici@mi.infn.it&gt;.</span>
<a name="l00143"></a>00143 <span class="stringliteral">        """</span>
<a name="l00144"></a>00144         s = <span class="stringliteral">'lambda '</span> + <span class="stringliteral">', '</span>.join(self.<a class="code" href="classgraphics_1_1StringFunction_1_1StringFunction.html#002a0b53d40f89646abd7e1dd94898bb">_var</a>_var)
<a name="l00145"></a>00145         <span class="comment">##s = 'lambda self, ' + ', '.join(self._var)</span>
<a name="l00146"></a>00146         <span class="comment"># add parameters as keyword arguments:</span>
<a name="l00147"></a>00147         <span class="keywordflow">if</span> self._prms:
<a name="l00148"></a>00148             s += <span class="stringliteral">', '</span> + <span class="stringliteral">', '</span>.join([<span class="stringliteral">'%s=%s'</span> % (k, self._prms[k]) \
<a name="l00149"></a>00149                                    <span class="keywordflow">for</span> k <span class="keywordflow">in</span> self._prms])
<a name="l00150"></a>00150         s += <span class="stringliteral">': '</span> + self.<a class="code" href="classgraphics_1_1StringFunction_1_1StringFunction.html#2e5f39be10d845ce0d915d994a05dd10">_f</a>_f
<a name="l00151"></a>00151         self.<a class="code" href="classgraphics_1_1StringFunction_1_1StringFunction.html#68d8fc8865c700ee04c22bb7d1c6e38e">_lambda</a>_lambda = s <span class="comment"># store lambda function code; just for convenience</span>
<a name="l00152"></a>00152         <span class="keywordflow">try</span>:
<a name="l00153"></a>00153             self.<a class="code" href="classgraphics_1_1StringFunction_1_1StringFunction.html#447afcb4d7c34d8f8ada51c01489e84b">__call__</a>__call__ = eval(s, self._globals)
<a name="l00154"></a>00154             <span class="comment">## the following makes all instances have the same function :-(</span>
<a name="l00155"></a><a class="code" href="classgraphics_1_1StringFunction_1_1StringFunction.html#eaa45f28c5b87a0353d601c1b4dbaabe">00155</a>             <span class="comment">##StringFunction.__call__ = eval(s, self._globals)</span>
<a name="l00156"></a>00156         <span class="keywordflow">except</span> NameError, e:
<a name="l00157"></a>00157             prm = str(e).split()[1]
<a name="l00158"></a>00158             <span class="keywordflow">raise</span> NameError, <span class="stringliteral">'name "%s" is not defined - if it is '</span>\
<a name="l00159"></a>00159                   <span class="stringliteral">'a parameter,\nset it in the constructor or the '</span>\
<a name="l00160"></a>00160                   <span class="stringliteral">'set_parameters method, or provide\nglobals=globals() '</span>\
<a name="l00161"></a>00161                   <span class="stringliteral">'in the constructor if "%s" is a global name in the '</span>\
<a name="l00162"></a>00162                   <span class="stringliteral">'calling code.'</span> % (prm, prm)
<a name="l00163"></a>00163         
<a name="l00164"></a>00164             
<a name="l00165"></a>00165     <span class="keyword">def </span><a class="code" href="classgraphics_1_1StringFunction_1_1StringFunction.html#1ffe4216411ef8495e13261d56459eaa">set_parameters</a>(self, **kwargs):
<a name="l00166"></a>00166         self._prms.update(kwargs)
<a name="l00167"></a><a class="code" href="classgraphics_1_1StringFunction_1_1StringFunction.html#90122508560b6ef2a5e06c76809ec5fe">00167</a>         self.<a class="code" href="classgraphics_1_1StringFunction_1_1StringFunction.html#54d1fafb7d88a7333a3662319c9ce184">_build_lambda</a>_build_lambda()
<a name="l00168"></a>00168 
<a name="l00169"></a>00169     <span class="keyword">def </span><a class="code" href="classgraphics_1_1StringFunction_1_1StringFunction.html#1a3f542182bb70accfcd7626eb2bb1a4">troubleshoot</a>(self, *args, **kwargs):
<a name="l00170"></a>00170         <span class="stringliteral">"""</span>
<a name="l00171"></a>00171 <span class="stringliteral">        Perform function evaluation call with lots of testing to</span>
<a name="l00172"></a>00172 <span class="stringliteral">        try to help the user with problems.</span>
<a name="l00173"></a>00173 <span class="stringliteral">        """</span>
<a name="l00174"></a>00174         <span class="keywordflow">try</span>:
<a name="l00175"></a>00175             v = self(*args, **kwargs)
<a name="l00176"></a>00176         <span class="keywordflow">except</span> TypeError, e:
<a name="l00177"></a>00177             <span class="keywordflow">if</span> str(e).find(<span class="stringliteral">'only rank-0 arrays can be converted to Python scalars'</span>) != -1:
<a name="l00178"></a>00178 
<a name="l00179"></a>00179                 <span class="keywordflow">print</span> <span class="stringliteral">'\nThe call resulted in the exception TypeError:'</span>
<a name="l00180"></a>00180                 <span class="keywordflow">print</span> e
<a name="l00181"></a>00181                 
<a name="l00182"></a>00182                 <span class="comment"># *args contains NumPy arrays and the operations in</span>
<a name="l00183"></a>00183                 <span class="comment"># the string formula are not compatible</span>
<a name="l00184"></a>00184 
<a name="l00185"></a>00185                 <span class="comment"># do we have intrinsic math functions of wrong type?</span>
<a name="l00186"></a>00186                 math_funcs = <span class="keyword">False</span>; not_NumPy = <span class="keyword">False</span>
<a name="l00187"></a>00187                 <span class="keywordflow">for</span> f <span class="keywordflow">in</span> math_functions:
<a name="l00188"></a>00188                     <span class="keywordflow">if</span> self.<a class="code" href="classgraphics_1_1StringFunction_1_1StringFunction.html#2e5f39be10d845ce0d915d994a05dd10">_f</a>_f.find(f) != -1:
<a name="l00189"></a><a class="code" href="classgraphics_1_1StringFunction_1_1StringFunction.html#3f64707547b6cff1129160b6ac702d5a">00189</a>                         math_funcs = <span class="keyword">True</span>
<a name="l00190"></a>00190                         <span class="keywordflow">if</span> str(type(f))[7:-2] != <span class="stringliteral">'ufunc'</span>:
<a name="l00191"></a>00191                             not_NumPy = <span class="keyword">True</span>
<a name="l00192"></a>00192                         <span class="keywordflow">break</span>
<a name="l00193"></a>00193                 <span class="keywordflow">if</span> math_funcs <span class="keywordflow">and</span> not_NumPy:
<a name="l00194"></a>00194                     <span class="keywordflow">print</span> <span class="stringliteral">'\nThis message is caused by using scalar math\n'</span>\
<a name="l00195"></a>00195                           <span class="stringliteral">'functions (like %s) with array arguments.\n'</span>\
<a name="l00196"></a>00196                           <span class="stringliteral">'Make some\nfrom numarray import *\n'</span>\
<a name="l00197"></a>00197                           <span class="stringliteral">'or similar in the calling code and '</span>\
<a name="l00198"></a>00198                           <span class="stringliteral">'supply the globals=globals() constructor\n'</span>\
<a name="l00199"></a>00199                           <span class="stringliteral">'argument when creating the StringFunction instance.'</span>\
<a name="l00200"></a>00200                           % f
<a name="l00201"></a>00201                 <span class="keywordflow">else</span>:
<a name="l00202"></a>00202                     <span class="keywordflow">print</span> <span class="stringliteral">'Internal error - this should not happen...'</span>
<a name="l00203"></a>00203             <span class="keywordflow">else</span>:
<a name="l00204"></a>00204                 <span class="keywordflow">print</span> e
<a name="l00205"></a>00205         <span class="keywordflow">except</span> NameError, e:
<a name="l00206"></a>00206             <span class="keywordflow">print</span> e
<a name="l00207"></a>00207         <span class="keywordflow">else</span>:
<a name="l00208"></a>00208             <span class="keywordflow">print</span> <span class="stringliteral">'This call worked perfectly!'</span>
<a name="l00209"></a>00209 
<a name="l00210"></a>00210     <span class="keyword">def </span><a class="code" href="classgraphics_1_1StringFunction_1_1StringFunction.html#390659207cf3f80216f3a2e2938751ed">__str__</a>(self):
<a name="l00211"></a>00211         <span class="stringliteral">"""</span>
<a name="l00212"></a>00212 <span class="stringliteral">        Return the string function formula as a string, with</span>
<a name="l00213"></a>00213 <span class="stringliteral">        parameters substituted by their values.</span>
<a name="l00214"></a>00214 <span class="stringliteral"></span>
<a name="l00215"></a>00215 <span class="stringliteral">        The return value can be used when creating Fortran or C/C++</span>
<a name="l00216"></a>00216 <span class="stringliteral">        functions out of the string formula:</span>
<a name="l00217"></a>00217 <span class="stringliteral">        f = StringFunction('a + p*x', a=1, p=0)</span>
<a name="l00218"></a>00218 <span class="stringliteral">        somefile.write('double somefunc(double x) { return %s; }' % str(f))</span>
<a name="l00219"></a>00219 <span class="stringliteral">        """</span>
<a name="l00220"></a>00220         s = self.<a class="code" href="classgraphics_1_1StringFunction_1_1StringFunction.html#2e5f39be10d845ce0d915d994a05dd10">_f</a>_f  <span class="comment"># formula with parameter names and indep. variables</span>
<a name="l00221"></a>00221 
<a name="l00222"></a>00222         <span class="comment"># Substitute parameter names by their numerical values.</span>
<a name="l00223"></a>00223         <span class="comment"># Start with the most complicated parameter names</span>
<a name="l00224"></a>00224         <span class="comment"># (this algorithm may fail).</span>
<a name="l00225"></a>00225         prm_names = self._prms.keys()
<a name="l00226"></a>00226         prm_names.sort(<span class="keyword">lambda</span> a, b: cmp(len(a), len(b)))
<a name="l00227"></a><a class="code" href="classgraphics_1_1StringFunction_1_1StringFunction.html#1ffb2250076b5562b14d78b3a5b5ffb5">00227</a>         prm_names.reverse()
<a name="l00228"></a>00228         <span class="keywordflow">for</span> name <span class="keywordflow">in</span> prm_names:
<a name="l00229"></a>00229             s = s.replace(name, str(self._prms[name]))
<a name="l00230"></a>00230         <span class="keywordflow">return</span> s
<a name="l00231"></a>00231 
<a name="l00232"></a>00232     <span class="keyword">def </span><a class="code" href="classgraphics_1_1StringFunction_1_1StringFunction.html#eaa45f28c5b87a0353d601c1b4dbaabe">__repr__</a>(self):
<a name="l00233"></a>00233         <span class="stringliteral">"""Return the code required to reconstruct this instance."""</span>
<a name="l00234"></a>00234         kwargs = <span class="stringliteral">', '</span>.join([<span class="stringliteral">'%s=%s'</span> % (key, repr(value)) \
<a name="l00235"></a>00235                             <span class="keywordflow">for</span> key, value <span class="keywordflow">in</span> self._prms.items()])
<a name="l00236"></a>00236         <span class="keywordflow">return</span> <span class="stringliteral">"""StringFunction(%s, independent_variables=%s, %s)"""</span> % \
<a name="l00237"></a>00237                (repr(self.<a class="code" href="classgraphics_1_1StringFunction_1_1StringFunction.html#2e5f39be10d845ce0d915d994a05dd10">_f</a>_f), repr(self.<a class="code" href="classgraphics_1_1StringFunction_1_1StringFunction.html#002a0b53d40f89646abd7e1dd94898bb">_var</a>_var), kwargs)
<a name="l00238"></a>00238 
<a name="l00239"></a>00239     <span class="comment"># The next code generation functions work only for scalar</span>
<a name="l00240"></a>00240     <span class="comment"># function values, not vector values (can extend to vectors by</span>
<a name="l00241"></a>00241     <span class="comment"># checking if self._f has a list form, and then include the</span>
<a name="l00242"></a>00242     <span class="comment"># return value as an array argument in the functions).</span>
<a name="l00243"></a>00243 
<a name="l00244"></a>00244     <span class="keyword">def </span><a class="code" href="classgraphics_1_1StringFunction_1_1StringFunction.html#90122508560b6ef2a5e06c76809ec5fe">_no_of_vector_components</a>(self):
<a name="l00245"></a>00245         <span class="stringliteral">"""</span>
<a name="l00246"></a>00246 <span class="stringliteral">        Return the number of vector components in the string</span>
<a name="l00247"></a>00247 <span class="stringliteral">        expression.</span>
<a name="l00248"></a>00248 <span class="stringliteral">        """</span>
<a name="l00249"></a>00249         ni = len(self.<a class="code" href="classgraphics_1_1StringFunction_1_1StringFunction.html#002a0b53d40f89646abd7e1dd94898bb">_var</a>_var)
<a name="l00250"></a>00250         <span class="keywordflow">if</span> ni == 1:
<a name="l00251"></a>00251             <span class="keywordflow">return</span> 1
<a name="l00252"></a>00252         <span class="comment"># function of more than one variable may be a vector field:</span>
<a name="l00253"></a>00253         args = tuple([0*ni])  <span class="comment"># try (0,0,...) as indep. variables</span>
<a name="l00254"></a>00254         <span class="keywordflow">try</span>:
<a name="l00255"></a>00255             v = self(args)
<a name="l00256"></a>00256         <span class="keywordflow">except</span>:
<a name="l00257"></a>00257             <span class="comment"># try another argument:</span>
<a name="l00258"></a>00258             args = tuple([1.105*ni])
<a name="l00259"></a>00259             <span class="keywordflow">try</span>:
<a name="l00260"></a>00260                 v = self(args)
<a name="l00261"></a>00261             <span class="keywordflow">except</span>:
<a name="l00262"></a>00262                 <span class="comment"># ???</span>
<a name="l00263"></a>00263                 
<a name="l00264"></a>00264         <span class="comment"># evaluate the function first:</span>
<a name="l00265"></a>00265         
<a name="l00266"></a>00266     <span class="keyword">def </span><a class="code" href="classgraphics_1_1StringFunction_1_1StringFunction.html#3f64707547b6cff1129160b6ac702d5a">Cpp_code</a>(self, function_name='somefunc'):
<a name="l00267"></a>00267         <span class="stringliteral">"""</span>
<a name="l00268"></a><a class="code" href="classgraphics_1_1StringFunction_1_1StringFunction.html#febc56e358d8e5d1c042ee1a6ca33fab">00268</a> <span class="stringliteral">        Dump the string expression to C++.</span>
<a name="l00269"></a>00269 <span class="stringliteral">        In C++ we use a plain function if there are no parameters,</span>
<a name="l00270"></a>00270 <span class="stringliteral">        otherwise we use a function object with operator() for</span>
<a name="l00271"></a>00271 <span class="stringliteral">        the function evaluation.</span>
<a name="l00272"></a>00272 <span class="stringliteral">        """</span>
<a name="l00273"></a>00273         varlist = <span class="stringliteral">', '</span>.join([<span class="stringliteral">'double %s'</span> % var <span class="keywordflow">for</span> var <span class="keywordflow">in</span> self.<a class="code" href="classgraphics_1_1StringFunction_1_1StringFunction.html#002a0b53d40f89646abd7e1dd94898bb">_var</a>_var])
<a name="l00274"></a>00274         expr = self.<a class="code" href="classgraphics_1_1StringFunction_1_1StringFunction.html#2e5f39be10d845ce0d915d994a05dd10">_f</a>_f
<a name="l00275"></a>00275         <span class="comment"># ** does not work in C, instead of doing sophisticated</span>
<a name="l00276"></a>00276         <span class="comment"># parsing and edit, provide an error message</span>
<a name="l00277"></a>00277         self.<a class="code" href="classgraphics_1_1StringFunction_1_1StringFunction.html#c7627433d30d2643d2470dff6e2cd16a">_pow_check</a>_pow_check()
<a name="l00278"></a>00278         <span class="keywordflow">if</span> self._prms:
<a name="l00279"></a>00279             decl = <span class="stringliteral">' '</span>.join([<span class="stringliteral">'double %s;'</span> % name <span class="keywordflow">for</span> name <span class="keywordflow">in</span> self._prms])
<a name="l00280"></a>00280             prms = <span class="stringliteral">', '</span>.join([<span class="stringliteral">'double %s_=%s'</span> % (name, self._prms[name]) \
<a name="l00281"></a>00281                     <span class="keywordflow">for</span> name <span class="keywordflow">in</span> self._prms])
<a name="l00282"></a>00282             setp = <span class="stringliteral">' '</span>.join([<span class="stringliteral">'%s = %s_;'</span> % (name, name) \
<a name="l00283"></a>00283                              <span class="keywordflow">for</span> name <span class="keywordflow">in</span> self._prms])
<a name="l00284"></a>00284             <span class="comment"># function object:</span>
<a name="l00285"></a>00285             s = <span class="stringliteral">"""</span>
<a name="l00286"></a>00286 <span class="stringliteral">class %(function_name)s</span>
<a name="l00287"></a>00287 <span class="stringliteral">{</span>
<a name="l00288"></a>00288 <span class="stringliteral">  // parameters:</span>
<a name="l00289"></a>00289 <span class="stringliteral">  %(decl)s</span>
<a name="l00290"></a>00290 <span class="stringliteral"> public:</span>
<a name="l00291"></a>00291 <span class="stringliteral">  %(function_name)s (%(prms)s)</span>
<a name="l00292"></a>00292 <span class="stringliteral">    { %(setp)s }</span>
<a name="l00293"></a>00293 <span class="stringliteral">  double operator() const (%(varlist)s)</span>
<a name="l00294"></a><a class="code" href="classgraphics_1_1StringFunction_1_1StringFunction.html#41b2988214b8bdfbaa1b3ead73c0e52a">00294</a> <span class="stringliteral">    { return %(expr)s; }</span>
<a name="l00295"></a>00295 <span class="stringliteral">};</span>
<a name="l00296"></a>00296 <span class="stringliteral">"""</span> % vars()
<a name="l00297"></a>00297         <span class="keywordflow">else</span>:
<a name="l00298"></a>00298             s = <span class="stringliteral">"""</span>
<a name="l00299"></a>00299 <span class="stringliteral">double %(function_name)s (%(varlist)s)</span>
<a name="l00300"></a>00300 <span class="stringliteral">{ return %(expr)s; }</span>
<a name="l00301"></a>00301 <span class="stringliteral">"""</span>
<a name="l00302"></a>00302         <span class="keywordflow">return</span> s
<a name="l00303"></a>00303             
<a name="l00304"></a>00304     <span class="keyword">def </span><a class="code" href="classgraphics_1_1StringFunction_1_1StringFunction.html#1ffb2250076b5562b14d78b3a5b5ffb5">F77_code</a>(self, function_name='somefunc'):
<a name="l00305"></a>00305         <span class="stringliteral">"""</span>
<a name="l00306"></a>00306 <span class="stringliteral">        Dump the string expressions as a Fortran 77 function or subroutine.</span>
<a name="l00307"></a>00307 <span class="stringliteral"></span>
<a name="l00308"></a>00308 <span class="stringliteral">        Note: if pow(x,a) is used in the expression, this is</span>
<a name="l00309"></a>00309 <span class="stringliteral">        translated to x**a by a simple regex, which may fail if</span>
<a name="l00310"></a>00310 <span class="stringliteral">        there are function calls inside pow(.,.).</span>
<a name="l00311"></a>00311 <span class="stringliteral">        """</span>
<a name="l00312"></a>00312         expr = self.<a class="code" href="classgraphics_1_1StringFunction_1_1StringFunction.html#2e5f39be10d845ce0d915d994a05dd10">_f</a>_f
<a name="l00313"></a>00313         real = <span class="stringliteral">'real*8'</span>
<a name="l00314"></a>00314         varlist = <span class="stringliteral">', '</span>.join(self.<a class="code" href="classgraphics_1_1StringFunction_1_1StringFunction.html#002a0b53d40f89646abd7e1dd94898bb">_var</a>_var)
<a name="l00315"></a>00315         varlist_decl = <span class="stringliteral">'\n'</span>.join([<span class="stringliteral">'      %s %s'</span> % (real, name) \
<a name="l00316"></a>00316                                   <span class="keywordflow">for</span> name <span class="keywordflow">in</span> self.<a class="code" href="classgraphics_1_1StringFunction_1_1StringFunction.html#002a0b53d40f89646abd7e1dd94898bb">_var</a>_var])
<a name="l00317"></a>00317         decl = <span class="stringliteral">'\n'</span>.join([<span class="stringliteral">'      %s %s'</span> % (real,name) <span class="keywordflow">for</span> name <span class="keywordflow">in</span> self._prms])
<a name="l00318"></a>00318         <span class="keyword">import</span> re
<a name="l00319"></a>00319         <span class="keywordflow">if</span> re.search(<span class="stringliteral">r'pow\s*\('</span>, expr):
<a name="l00320"></a>00320             <span class="comment"># try to replace pow(x,a) by x**a</span>
<a name="l00321"></a>00321             expr = re.sub(<span class="stringliteral">r'pow\(([^,]+),([^)]+)\)'</span>, <span class="stringliteral">'((\g&lt;1&gt;)**(\g&lt;2&gt;))'</span>,
<a name="l00322"></a><a class="code" href="classgraphics_1_1StringFunction_1_1StringFunction.html#c7627433d30d2643d2470dff6e2cd16a">00322</a>                           expr)
<a name="l00323"></a>00323         <span class="comment"># set parameter values:</span>
<a name="l00324"></a>00324         setp = <span class="stringliteral">'\n'</span>.join([<span class="stringliteral">'      %s = %s'</span> % (name, self._prms[name]) \
<a name="l00325"></a>00325                           <span class="keywordflow">for</span> name <span class="keywordflow">in</span> self._prms])
<a name="l00326"></a>00326         s = <span class="stringliteral">"""</span>
<a name="l00327"></a>00327 <span class="stringliteral">      %(real)s function %(function_name)s(%(varlist)s)</span>
<a name="l00328"></a>00328 <span class="stringliteral">C     independent variables:</span>
<a name="l00329"></a>00329 <span class="stringliteral">%(varlist_decl)s</span>
<a name="l00330"></a>00330 <span class="stringliteral">"""</span> % vars()
<a name="l00331"></a>00331         <span class="keywordflow">if</span> self._prms:
<a name="l00332"></a>00332             s += <span class="stringliteral">"""</span>
<a name="l00333"></a>00333 <span class="stringliteral">C     parameters:</span>
<a name="l00334"></a>00334 <span class="stringliteral">%(decl)s</span>
<a name="l00335"></a>00335 <span class="stringliteral">%(setp)s</span>
<a name="l00336"></a>00336 <span class="stringliteral">"""</span> % vars()
<a name="l00337"></a>00337         s += <span class="stringliteral">"""</span>
<a name="l00338"></a>00338 <span class="stringliteral">      %(function_name)s = %(expr)s</span>
<a name="l00339"></a>00339 <span class="stringliteral"></span>
<a name="l00340"></a>00340 <span class="stringliteral">      return</span>
<a name="l00341"></a>00341 <span class="stringliteral">      end</span>
<a name="l00342"></a>00342 <span class="stringliteral">"""</span> % vars()
<a name="l00343"></a>00343         <span class="keywordflow">return</span> s
<a name="l00344"></a>00344 
<a name="l00345"></a>00345     <span class="keyword">def </span><a class="code" href="classgraphics_1_1StringFunction_1_1StringFunction.html#febc56e358d8e5d1c042ee1a6ca33fab">F77_pow</a>(self):
<a name="l00346"></a>00346         <span class="stringliteral">"""</span>
<a name="l00347"></a>00347 <span class="stringliteral">        Generate an F77 function pow(x,a) (x**a). In some</span>
<a name="l00348"></a>00348 <span class="stringliteral">        string expressions that are to be translated to C/C++,</span>
<a name="l00349"></a>00349 <span class="stringliteral">        pow(x,a) must be used instead of x**a, but pow is not</span>
<a name="l00350"></a>00350 <span class="stringliteral">        defined in F77. This code dumpes the necessary F77 version</span>
<a name="l00351"></a>00351 <span class="stringliteral">        of pow such that string functions can be seamlessly translated</span>
<a name="l00352"></a>00352 <span class="stringliteral">        to C, C++, and F77.</span>
<a name="l00353"></a>00353 <span class="stringliteral"></span>
<a name="l00354"></a>00354 <span class="stringliteral">        Note: this function is difficult to use since it expects</span>
<a name="l00355"></a>00355 <span class="stringliteral">        exactly a single-precision power. We now rely on regular</span>
<a name="l00356"></a>00356 <span class="stringliteral">        expressions to replace pow(x,a) by x**a in F77_code instead.</span>
<a name="l00357"></a>00357 <span class="stringliteral">        """</span>
<a name="l00358"></a>00358         s = <span class="stringliteral">"""</span>
<a name="l00359"></a>00359 <span class="stringliteral"></span>
<a name="l00360"></a>00360 <span class="stringliteral">      real*8 function pow(x, a)</span>
<a name="l00361"></a>00361 <span class="stringliteral">      real*8 x</span>
<a name="l00362"></a>00362 <span class="stringliteral">C     the power a is usually a number (single precision),</span>
<a name="l00363"></a>00363 <span class="stringliteral">C     note: it cannot be int</span>
<a name="l00364"></a>00364 <span class="stringliteral">      real*4 a</span>
<a name="l00365"></a>00365 <span class="stringliteral">      pow = x**a</span>
<a name="l00366"></a>00366 <span class="stringliteral">      return</span>
<a name="l00367"></a>00367 <span class="stringliteral">      end</span>
<a name="l00368"></a>00368 <span class="stringliteral">"""</span>
<a name="l00369"></a>00369         <span class="keywordflow">return</span> s
<a name="l00370"></a>00370     
<a name="l00371"></a>00371     <span class="keyword">def </span><a class="code" href="classgraphics_1_1StringFunction_1_1StringFunction.html#41b2988214b8bdfbaa1b3ead73c0e52a">C_code</a>(self, function_name='somefunc', inline=False):
<a name="l00372"></a>00372         <span class="stringliteral">"""</span>
<a name="l00373"></a>00373 <span class="stringliteral">        Dump the string expressions as a C function.</span>
<a name="l00374"></a>00374 <span class="stringliteral">        If inline is true, the C++ inline keyword is inserted</span>
<a name="l00375"></a>00375 <span class="stringliteral">        to make the function inline.</span>
<a name="l00376"></a>00376 <span class="stringliteral">        """</span>
<a name="l00377"></a>00377         <span class="keywordflow">if</span> inline:
<a name="l00378"></a>00378             s = <span class="stringliteral">'inline '</span>
<a name="l00379"></a>00379         <span class="keywordflow">else</span>:
<a name="l00380"></a>00380             s = <span class="stringliteral">''</span>
<a name="l00381"></a>00381         expr = self.<a class="code" href="classgraphics_1_1StringFunction_1_1StringFunction.html#2e5f39be10d845ce0d915d994a05dd10">_f</a>_f
<a name="l00382"></a>00382         <span class="comment"># ** does not work in C, instead of doing sophisticated</span>
<a name="l00383"></a>00383         <span class="comment"># parsing and edit, provide an error message</span>
<a name="l00384"></a>00384         self.<a class="code" href="classgraphics_1_1StringFunction_1_1StringFunction.html#c7627433d30d2643d2470dff6e2cd16a">_pow_check</a>_pow_check()
<a name="l00385"></a>00385         
<a name="l00386"></a>00386         varlist = <span class="stringliteral">', '</span>.join([<span class="stringliteral">'double %s'</span> % var <span class="keywordflow">for</span> var <span class="keywordflow">in</span> self.<a class="code" href="classgraphics_1_1StringFunction_1_1StringFunction.html#002a0b53d40f89646abd7e1dd94898bb">_var</a>_var])
<a name="l00387"></a>00387         s += <span class="stringliteral">'double %s (%s)\n{\n'</span> % (function_name, varlist)
<a name="l00388"></a>00388         <span class="keywordflow">if</span> self._prms:
<a name="l00389"></a>00389             <span class="comment"># declare variables for parameters:</span>
<a name="l00390"></a>00390             decl = <span class="stringliteral">' '</span>.join([<span class="stringliteral">'double %s;'</span> % name <span class="keywordflow">for</span> name <span class="keywordflow">in</span> self._prms])
<a name="l00391"></a>00391             <span class="comment"># set parameter values:</span>
<a name="l00392"></a>00392             prms = <span class="stringliteral">' '</span>.join([<span class="stringliteral">'%s = %s;'</span> % (name, self._prms[name]) \
<a name="l00393"></a>00393                             <span class="keywordflow">for</span> name <span class="keywordflow">in</span> self._prms])
<a name="l00394"></a>00394             s += <span class="stringliteral">'  %s\n  %s\n'</span> % (decl, prms)
<a name="l00395"></a>00395         <span class="comment"># evaluate math expression:</span>
<a name="l00396"></a>00396         s += <span class="stringliteral">'  return '</span> + expr + <span class="stringliteral">';\n}\n'</span>
<a name="l00397"></a>00397         <span class="keywordflow">return</span> s
<a name="l00398"></a>00398             
<a name="l00399"></a>00399     <span class="keyword">def </span><a class="code" href="classgraphics_1_1StringFunction_1_1StringFunction.html#c7627433d30d2643d2470dff6e2cd16a">_pow_check</a>(self):
<a name="l00400"></a>00400         <span class="stringliteral">"""</span>
<a name="l00401"></a>00401 <span class="stringliteral">        Raise a SyntaxError exception if the ** power operator is used</span>
<a name="l00402"></a>00402 <span class="stringliteral">        in the string formula.</span>
<a name="l00403"></a>00403 <span class="stringliteral">        """</span>
<a name="l00404"></a>00404         <span class="keywordflow">if</span> self.<a class="code" href="classgraphics_1_1StringFunction_1_1StringFunction.html#2e5f39be10d845ce0d915d994a05dd10">_f</a>_f.find(<span class="stringliteral">'**'</span>) != -1:
<a name="l00405"></a>00405             <span class="keywordflow">raise</span> SyntaxError, \
<a name="l00406"></a>00406                   <span class="stringliteral">'use pow(a,b) instead of a**b in the expression'</span>\
<a name="l00407"></a>00407                   <span class="stringliteral">'\n%s\n(since you demand translation to C/C++)'</span> % self.<a class="code" href="classgraphics_1_1StringFunction_1_1StringFunction.html#2e5f39be10d845ce0d915d994a05dd10">_f</a>_f
<a name="l00408"></a>00408         
<a name="l00409"></a><a class="code" href="namespacegraphics_1_1StringFunction.html#808688f1c65b3d80192e838c2c120594">00409</a> <span class="keyword">def </span><a class="code" href="namespacegraphics_1_1StringFunction.html#808688f1c65b3d80192e838c2c120594">_test</a>():
<a name="l00410"></a>00410     <span class="keyword">import</span> doctest, StringFunction
<a name="l00411"></a>00411     <span class="keywordflow">return</span> doctest.testmod(StringFunction)
<a name="l00412"></a>00412 
<a name="l00413"></a><a class="code" href="namespacegraphics_1_1StringFunction.html#5aa071925a645e12cf8864bd62b15e3b">00413</a> <span class="keyword">def </span><a class="code" href="namespacegraphics_1_1StringFunction.html#5aa071925a645e12cf8864bd62b15e3b">_demo</a>():
<a name="l00414"></a>00414     f = StringFunction(<span class="stringliteral">'a+b*sin(x)'</span>, a=1, b=4)
<a name="l00415"></a>00415     <span class="keywordflow">print</span> f(2)
<a name="l00416"></a>00416     f.set_parameters(a=-1, b=pi)
<a name="l00417"></a>00417     <span class="keywordflow">print</span> f(1)
<a name="l00418"></a>00418     <span class="keywordflow">print</span> <span class="stringliteral">'internals:'</span>, str(f), repr(f), f._lambda, f._prms
<a name="l00419"></a>00419     f = StringFunction(<span class="stringliteral">'amp*sin(a*t)*exp(-6.211*x)'</span>,
<a name="l00420"></a>00420                        independent_variables=(<span class="stringliteral">'x'</span>,<span class="stringliteral">'t'</span>))
<a name="l00421"></a>00421     f.set_parameters(amp=0.1, a=1)
<a name="l00422"></a>00422     <span class="keywordflow">print</span> f(0,pi/2.0,a=2)
<a name="l00423"></a>00423     <span class="keywordflow">print</span> <span class="stringliteral">'internals:'</span>, str(f), repr(f), f._lambda, f._prms
<a name="l00424"></a>00424     <span class="keywordflow">print</span> f.C_code()
<a name="l00425"></a>00425     <span class="keywordflow">print</span> f.Cpp_code()
<a name="l00426"></a>00426     <span class="keywordflow">print</span> f.F77_code()
<a name="l00427"></a>00427 
<a name="l00428"></a>00428 
<a name="l00429"></a>00429 <span class="comment"># simplified "pedagogical" versions from the</span>
<a name="l00430"></a>00430 <span class="comment"># "Python for Computational Science" book:</span>
<a name="l00431"></a>00431 
<a name="l00432"></a><a class="code" href="classgraphics_1_1StringFunction_1_1StringFunction__v1.html">00432</a> <span class="keyword">class </span><a class="code" href="classgraphics_1_1StringFunction_1_1StringFunction__v1.html">StringFunction_v1</a>:
<a name="l00433"></a><a class="code" href="classgraphics_1_1StringFunction_1_1StringFunction__v1.html#d7f57406bcc36fa6793a7def7c119b4a">00433</a>     <span class="keyword">def </span><a class="code" href="classgraphics_1_1StringFunction_1_1StringFunction__v1.html#d7f57406bcc36fa6793a7def7c119b4a">__init__</a>(self, expression):
<a name="l00434"></a><a class="code" href="classgraphics_1_1StringFunction_1_1StringFunction__v1.html#0ea4db92098bdddfa52cfb09efd4c88b">00434</a>         self.<a class="code" href="classgraphics_1_1StringFunction_1_1StringFunction__v1.html#0ea4db92098bdddfa52cfb09efd4c88b">_f</a>_f = expression
<a name="l00435"></a>00435 
<a name="l00436"></a><a class="code" href="classgraphics_1_1StringFunction_1_1StringFunction__v1.html#6ba5ad40a6ab8ea99acdcd187e5399e3">00436</a>     <span class="keyword">def </span><a class="code" href="classgraphics_1_1StringFunction_1_1StringFunction__v1.html#6ba5ad40a6ab8ea99acdcd187e5399e3">__call__</a>(self, x):
<a name="l00437"></a>00437         <span class="keywordflow">return</span> eval(self.<a class="code" href="classgraphics_1_1StringFunction_1_1StringFunction__v1.html#0ea4db92098bdddfa52cfb09efd4c88b">_f</a>_f)  <span class="comment"># evaluate function expression</span>
<a name="l00438"></a>00438 
<a name="l00439"></a>00439 <span class="comment"># compile eval expression:</span>
<a name="l00440"></a><a class="code" href="classgraphics_1_1StringFunction_1_1StringFunction__v2.html">00440</a> <span class="keyword">class </span><a class="code" href="classgraphics_1_1StringFunction_1_1StringFunction__v2.html">StringFunction_v2</a>:
<a name="l00441"></a><a class="code" href="classgraphics_1_1StringFunction_1_1StringFunction__v2.html#6158c06beabfbc92d2ff3f50b9f21cf8">00441</a>     <span class="keyword">def </span><a class="code" href="classgraphics_1_1StringFunction_1_1StringFunction__v2.html#6158c06beabfbc92d2ff3f50b9f21cf8">__init__</a>(self, expression):
<a name="l00442"></a><a class="code" href="classgraphics_1_1StringFunction_1_1StringFunction__v2.html#55f7d8ad187cc2201a5d05d6ea640340">00442</a>         self.<a class="code" href="classgraphics_1_1StringFunction_1_1StringFunction__v2.html#55f7d8ad187cc2201a5d05d6ea640340">_f_compiled</a>_f_compiled = compile(expression, <span class="stringliteral">'&lt;string&gt;'</span>, <span class="stringliteral">'eval'</span>)
<a name="l00443"></a>00443 
<a name="l00444"></a><a class="code" href="classgraphics_1_1StringFunction_1_1StringFunction__v2.html#cc3d3ec35f6bca5d1c90ff5cbf8712a2">00444</a>     <span class="keyword">def </span><a class="code" href="classgraphics_1_1StringFunction_1_1StringFunction__v2.html#cc3d3ec35f6bca5d1c90ff5cbf8712a2">__call__</a>(self, x):
<a name="l00445"></a>00445         <span class="keywordflow">return</span> eval(self.<a class="code" href="classgraphics_1_1StringFunction_1_1StringFunction__v2.html#55f7d8ad187cc2201a5d05d6ea640340">_f_compiled</a>_f_compiled)
<a name="l00446"></a>00446 
<a name="l00447"></a>00447 <span class="comment"># allow parameters and an arbitrary name of the independent variable:</span>
<a name="l00448"></a><a class="code" href="classgraphics_1_1StringFunction_1_1StringFunction__v3.html">00448</a> <span class="keyword">class </span><a class="code" href="classgraphics_1_1StringFunction_1_1StringFunction__v3.html">StringFunction_v3</a>:
<a name="l00449"></a><a class="code" href="classgraphics_1_1StringFunction_1_1StringFunction__v3.html#14da968a9184226a9e66589408851d0d">00449</a>     <span class="keyword">def </span><a class="code" href="classgraphics_1_1StringFunction_1_1StringFunction__v3.html#14da968a9184226a9e66589408851d0d">__init__</a>(self, expression,
<a name="l00450"></a><a class="code" href="classgraphics_1_1StringFunction_1_1StringFunction__v3.html#32ad932276c8a02d3f15c94bcb5a7d58">00450</a>                  independent_variable=<span class="stringliteral">'x'</span>,
<a name="l00451"></a><a class="code" href="classgraphics_1_1StringFunction_1_1StringFunction__v3.html#7778a7f0a6c15d32de7b5adb4d406253">00451</a>                  set_parameters=<span class="stringliteral">''</span>):
<a name="l00452"></a><a class="code" href="classgraphics_1_1StringFunction_1_1StringFunction__v3.html#c92f098ac175ac1d93ef2e191c06b220">00452</a>         self.<a class="code" href="classgraphics_1_1StringFunction_1_1StringFunction__v3.html#32ad932276c8a02d3f15c94bcb5a7d58">_f_compiled</a>_f_compiled = compile(expression, <span class="stringliteral">'&lt;string&gt;'</span>, <span class="stringliteral">'eval'</span>)
<a name="l00453"></a><a class="code" href="classgraphics_1_1StringFunction_1_1StringFunction__v3.html#fe8b40075edded714105d34791744d0c">00453</a>         self.<a class="code" href="classgraphics_1_1StringFunction_1_1StringFunction__v3.html#7778a7f0a6c15d32de7b5adb4d406253">_var</a>_var = independent_variable  <span class="comment"># 'x', 't' etc.</span>
<a name="l00454"></a>00454         self.<a class="code" href="classgraphics_1_1StringFunction_1_1StringFunction__v3.html#c92f098ac175ac1d93ef2e191c06b220">_code</a>_code = set_parameters
<a name="l00455"></a>00455         self.<a class="code" href="classgraphics_1_1StringFunction_1_1StringFunction__v3.html#fe8b40075edded714105d34791744d0c">__name__</a>__name__ = expression  <span class="comment"># name of func is expression</span>
<a name="l00456"></a>00456 
<a name="l00457"></a><a class="code" href="classgraphics_1_1StringFunction_1_1StringFunction__v3.html#acb31ac00e2f1838769fd2a4eab8629c">00457</a>     <span class="keyword">def </span><a class="code" href="classgraphics_1_1StringFunction_1_1StringFunction__v3.html#acb31ac00e2f1838769fd2a4eab8629c">set_parameters</a>(self, code):
<a name="l00458"></a>00458         self.<a class="code" href="classgraphics_1_1StringFunction_1_1StringFunction__v3.html#c92f098ac175ac1d93ef2e191c06b220">_code</a>_code = code
<a name="l00459"></a>00459 
<a name="l00460"></a><a class="code" href="classgraphics_1_1StringFunction_1_1StringFunction__v3.html#7c450c3aecd4f95e2a7df5bb5a6a1036">00460</a>     <span class="keyword">def </span><a class="code" href="classgraphics_1_1StringFunction_1_1StringFunction__v3.html#7c450c3aecd4f95e2a7df5bb5a6a1036">__call__</a>(self, x):
<a name="l00461"></a>00461         <span class="comment"># assign value to independent variable:</span>
<a name="l00462"></a>00462         exec <span class="stringliteral">'%s = %g'</span> % (self.<a class="code" href="classgraphics_1_1StringFunction_1_1StringFunction__v3.html#7778a7f0a6c15d32de7b5adb4d406253">_var</a>_var, x)
<a name="l00463"></a>00463         <span class="comment"># execute some user code (defining parameters etc.):</span>
<a name="l00464"></a>00464         <span class="keywordflow">if</span> self.<a class="code" href="classgraphics_1_1StringFunction_1_1StringFunction__v3.html#c92f098ac175ac1d93ef2e191c06b220">_code</a>_code:  exec(self.<a class="code" href="classgraphics_1_1StringFunction_1_1StringFunction__v3.html#c92f098ac175ac1d93ef2e191c06b220">_code</a>_code)
<a name="l00465"></a>00465         <span class="keywordflow">return</span> eval(self.<a class="code" href="classgraphics_1_1StringFunction_1_1StringFunction__v3.html#32ad932276c8a02d3f15c94bcb5a7d58">_f_compiled</a>_f_compiled)
<a name="l00466"></a>00466 
<a name="l00467"></a>00467 <span class="comment"># let parameters be keyword arguments:</span>
<a name="l00468"></a><a class="code" href="classgraphics_1_1StringFunction_1_1StringFunction__v4.html">00468</a> <span class="keyword">class </span><a class="code" href="classgraphics_1_1StringFunction_1_1StringFunction__v4.html">StringFunction_v4</a>:
<a name="l00469"></a><a class="code" href="classgraphics_1_1StringFunction_1_1StringFunction__v4.html#7c57a824dea95f580da5db67fcb9e484">00469</a>     <span class="keyword">def </span><a class="code" href="classgraphics_1_1StringFunction_1_1StringFunction__v4.html#7c57a824dea95f580da5db67fcb9e484">__init__</a>(self, expression, **kwargs):
<a name="l00470"></a><a class="code" href="classgraphics_1_1StringFunction_1_1StringFunction__v4.html#a64116ce16cfa23d6db421ef014cfa66">00470</a>         self.<a class="code" href="classgraphics_1_1StringFunction_1_1StringFunction__v4.html#a64116ce16cfa23d6db421ef014cfa66">_f</a>_f = expression
<a name="l00471"></a><a class="code" href="classgraphics_1_1StringFunction_1_1StringFunction__v4.html#a45ba24d8916504ffa12407a9263caf4">00471</a>         self.<a class="code" href="classgraphics_1_1StringFunction_1_1StringFunction__v4.html#a45ba24d8916504ffa12407a9263caf4">_var</a>_var = kwargs.get(<span class="stringliteral">'independent_variable'</span>, <span class="stringliteral">'x'</span>) <span class="comment"># 'x', 't' etc.</span>
<a name="l00472"></a><a class="code" href="classgraphics_1_1StringFunction_1_1StringFunction__v4.html#7f48d3a54befbcc54a0aa9759805bdc9">00472</a>         self.<a class="code" href="classgraphics_1_1StringFunction_1_1StringFunction__v4.html#7f48d3a54befbcc54a0aa9759805bdc9">_globals</a>_globals = kwargs.get(<span class="stringliteral">'globals'</span>, globals())
<a name="l00473"></a><a class="code" href="classgraphics_1_1StringFunction_1_1StringFunction__v4.html#8d80c794a845db20ccdaa71633aa4a10">00473</a>         self.<a class="code" href="classgraphics_1_1StringFunction_1_1StringFunction__v4.html#8d80c794a845db20ccdaa71633aa4a10">__name__</a>__name__ = self.<a class="code" href="classgraphics_1_1StringFunction_1_1StringFunction__v4.html#a64116ce16cfa23d6db421ef014cfa66">_f</a>_f  <span class="comment"># class name = function expression</span>
<a name="l00474"></a><a class="code" href="classgraphics_1_1StringFunction_1_1StringFunction__v4.html#847ad22d9d11760a5e2b1ff4e627938d">00474</a>         self.<a class="code" href="classgraphics_1_1StringFunction_1_1StringFunction__v4.html#847ad22d9d11760a5e2b1ff4e627938d">_f_compiled</a>_f_compiled = compile(self.<a class="code" href="classgraphics_1_1StringFunction_1_1StringFunction__v4.html#a64116ce16cfa23d6db421ef014cfa66">_f</a>_f, <span class="stringliteral">'&lt;string&gt;'</span>, <span class="stringliteral">'eval'</span>)
<a name="l00475"></a><a class="code" href="classgraphics_1_1StringFunction_1_1StringFunction__v4.html#01f0267dc851e4cbed697f77ea1d11fb">00475</a>         self.<a class="code" href="classgraphics_1_1StringFunction_1_1StringFunction__v4.html#01f0267dc851e4cbed697f77ea1d11fb">_prms</a>_prms = kwargs.copy()
<a name="l00476"></a>00476         <span class="keywordflow">try</span>:
<a name="l00477"></a>00477             del self.<a class="code" href="classgraphics_1_1StringFunction_1_1StringFunction__v4.html#01f0267dc851e4cbed697f77ea1d11fb">_prms</a>_prms[<span class="stringliteral">'independent_variable'</span>]
<a name="l00478"></a>00478             del self.<a class="code" href="classgraphics_1_1StringFunction_1_1StringFunction__v4.html#01f0267dc851e4cbed697f77ea1d11fb">_prms</a>_prms[<span class="stringliteral">'globals'</span>]
<a name="l00479"></a>00479         <span class="keywordflow">except</span>: <span class="keywordflow">pass</span>
<a name="l00480"></a>00480 
<a name="l00481"></a><a class="code" href="classgraphics_1_1StringFunction_1_1StringFunction__v4.html#1b2d8c1e7ec6a583bcedcce9148f5371">00481</a>     <span class="keyword">def </span><a class="code" href="classgraphics_1_1StringFunction_1_1StringFunction__v4.html#1b2d8c1e7ec6a583bcedcce9148f5371">set_parameters</a>(self, **kwargs):
<a name="l00482"></a>00482         self.<a class="code" href="classgraphics_1_1StringFunction_1_1StringFunction__v4.html#01f0267dc851e4cbed697f77ea1d11fb">_prms</a>_prms.update(kwargs)
<a name="l00483"></a>00483 
<a name="l00484"></a><a class="code" href="classgraphics_1_1StringFunction_1_1StringFunction__v4.html#8a91696285e3b32cc46a2686b48d5403">00484</a>     <span class="keyword">def </span><a class="code" href="classgraphics_1_1StringFunction_1_1StringFunction__v4.html#8a91696285e3b32cc46a2686b48d5403">__call__</a>(self, x):
<a name="l00485"></a>00485         <span class="comment"># include indep. variable in dictionary of function parameters:</span>
<a name="l00486"></a>00486         self.<a class="code" href="classgraphics_1_1StringFunction_1_1StringFunction__v4.html#01f0267dc851e4cbed697f77ea1d11fb">_prms</a>_prms[self.<a class="code" href="classgraphics_1_1StringFunction_1_1StringFunction__v4.html#a45ba24d8916504ffa12407a9263caf4">_var</a>_var] = x
<a name="l00487"></a>00487         <span class="comment"># evaluate function expression:</span>
<a name="l00488"></a>00488         <span class="keywordflow">return</span> eval(self.<a class="code" href="classgraphics_1_1StringFunction_1_1StringFunction__v4.html#847ad22d9d11760a5e2b1ff4e627938d">_f_compiled</a>_f_compiled, self.<a class="code" href="classgraphics_1_1StringFunction_1_1StringFunction__v4.html#7f48d3a54befbcc54a0aa9759805bdc9">_globals</a>_globals, self.<a class="code" href="classgraphics_1_1StringFunction_1_1StringFunction__v4.html#01f0267dc851e4cbed697f77ea1d11fb">_prms</a>_prms)
<a name="l00489"></a>00489 
<a name="l00490"></a><a class="code" href="classgraphics_1_1StringFunction_1_1StringFunction__v4.html#6cbf36b29a1de321240d00d21cc69f4a">00490</a>     <span class="keyword">def </span><a class="code" href="classgraphics_1_1StringFunction_1_1StringFunction__v4.html#6cbf36b29a1de321240d00d21cc69f4a">test</a>(self, x=1.4325):
<a name="l00491"></a>00491         <span class="comment"># test that all parameters are defined</span>
<a name="l00492"></a>00492         <span class="keywordflow">try</span>:
<a name="l00493"></a>00493             self(x)  <span class="comment"># sample call</span>
<a name="l00494"></a>00494             <span class="keywordflow">return</span> <span class="keyword">True</span>
<a name="l00495"></a>00495         <span class="keywordflow">except</span> NameError, e:
<a name="l00496"></a>00496             prm = str(e).split()[2]
<a name="l00497"></a>00497             <span class="keywordflow">raise</span> NameError, <span class="stringliteral">'Parameter "%s" is not defined,\nneither in '</span>\
<a name="l00498"></a>00498                   <span class="stringliteral">'the constructor nor set_parameters.\n'</span>\
<a name="l00499"></a>00499                   <span class="stringliteral">'Update the constructor call or call set_parameters'</span>\
<a name="l00500"></a>00500                   <span class="stringliteral">'(%s=...)'</span> % (prm, prm)
<a name="l00501"></a>00501         <span class="keywordflow">else</span>:
<a name="l00502"></a>00502             <span class="keywordflow">return</span> <span class="keyword">True</span>  <span class="comment"># accept other errors</span>
<a name="l00503"></a>00503         
<a name="l00504"></a><a class="code" href="classgraphics_1_1StringFunction_1_1StringFunction__v4.html#943f6eb4e23a31e7b200e0769d5cd99a">00504</a>     <span class="keyword">def </span><a class="code" href="classgraphics_1_1StringFunction_1_1StringFunction__v4.html#943f6eb4e23a31e7b200e0769d5cd99a">__str__</a>(self):
<a name="l00505"></a>00505         s = self.<a class="code" href="classgraphics_1_1StringFunction_1_1StringFunction__v4.html#a64116ce16cfa23d6db421ef014cfa66">_f</a>_f
<a name="l00506"></a>00506         <span class="comment"># Substitute parameter names by their numerical values.</span>
<a name="l00507"></a>00507         <span class="comment"># Start with the most complicated parameter names</span>
<a name="l00508"></a>00508         <span class="comment"># (this algorithm may fail).</span>
<a name="l00509"></a>00509 
<a name="l00510"></a>00510         <span class="comment"># first remove indep. variables possibly inserted in self._prms</span>
<a name="l00511"></a>00511         <span class="comment"># by the self.__call__ method:</span>
<a name="l00512"></a>00512         <span class="keywordflow">try</span>:
<a name="l00513"></a>00513             del self.<a class="code" href="classgraphics_1_1StringFunction_1_1StringFunction__v4.html#01f0267dc851e4cbed697f77ea1d11fb">_prms</a>_prms[self.<a class="code" href="classgraphics_1_1StringFunction_1_1StringFunction__v4.html#a45ba24d8916504ffa12407a9263caf4">_var</a>_var]
<a name="l00514"></a>00514         <span class="keywordflow">except</span>:
<a name="l00515"></a>00515             <span class="keywordflow">pass</span>
<a name="l00516"></a>00516         prm_names = self.<a class="code" href="classgraphics_1_1StringFunction_1_1StringFunction__v4.html#01f0267dc851e4cbed697f77ea1d11fb">_prms</a>_prms.keys()
<a name="l00517"></a>00517         prm_names.sort(<span class="keyword">lambda</span> a, b: cmp(len(a), len(b)))
<a name="l00518"></a>00518         prm_names.reverse()
<a name="l00519"></a>00519         <span class="keywordflow">for</span> name <span class="keywordflow">in</span> prm_names:
<a name="l00520"></a>00520             s = s.replace(name, str(self.<a class="code" href="classgraphics_1_1StringFunction_1_1StringFunction__v4.html#01f0267dc851e4cbed697f77ea1d11fb">_prms</a>_prms[name]))
<a name="l00521"></a>00521         <span class="keywordflow">return</span> s
<a name="l00522"></a>00522 
<a name="l00523"></a><a class="code" href="classgraphics_1_1StringFunction_1_1StringFunction__v4.html#b4a6d4b808117a0ea98ce3874c31a555">00523</a>     <span class="keyword">def </span><a class="code" href="classgraphics_1_1StringFunction_1_1StringFunction__v4.html#b4a6d4b808117a0ea98ce3874c31a555">__repr__</a>(self):
<a name="l00524"></a>00524         <span class="comment"># first remove indep. variables possibly inserted in self._prms</span>
<a name="l00525"></a>00525         <span class="comment"># by the self.__call__ method:</span>
<a name="l00526"></a>00526         <span class="keywordflow">try</span>:
<a name="l00527"></a>00527             del self.<a class="code" href="classgraphics_1_1StringFunction_1_1StringFunction__v4.html#01f0267dc851e4cbed697f77ea1d11fb">_prms</a>_prms[self.<a class="code" href="classgraphics_1_1StringFunction_1_1StringFunction__v4.html#a45ba24d8916504ffa12407a9263caf4">_var</a>_var]
<a name="l00528"></a>00528         <span class="keywordflow">except</span>:
<a name="l00529"></a>00529             <span class="keywordflow">pass</span>
<a name="l00530"></a>00530         kwargs = <span class="stringliteral">', '</span>.join([<span class="stringliteral">'%s=%s'</span> % (key, repr(value)) \
<a name="l00531"></a>00531                             <span class="keywordflow">for</span> key, value <span class="keywordflow">in</span> self.<a class="code" href="classgraphics_1_1StringFunction_1_1StringFunction__v4.html#01f0267dc851e4cbed697f77ea1d11fb">_prms</a>_prms.items()])
<a name="l00532"></a>00532         <span class="keywordflow">return</span> <span class="stringliteral">"""StringFunction1(%s, independent_variable=%s, %s)"""</span> % \
<a name="l00533"></a>00533                (repr(self.<a class="code" href="classgraphics_1_1StringFunction_1_1StringFunction__v4.html#a64116ce16cfa23d6db421ef014cfa66">_f</a>_f), repr(self.<a class="code" href="classgraphics_1_1StringFunction_1_1StringFunction__v4.html#a45ba24d8916504ffa12407a9263caf4">_var</a>_var), kwargs)
<a name="l00534"></a>00534 
<a name="l00535"></a><a class="code" href="classgraphics_1_1StringFunction_1_1StringFunction__v5.html">00535</a> <span class="keyword">class </span><a class="code" href="classgraphics_1_1StringFunction_1_1StringFunction__v5.html">StringFunction_v5</a>(<a class="code" href="classgraphics_1_1StringFunction_1_1StringFunction__v4.html">StringFunction_v4</a>):
<a name="l00536"></a>00536     <span class="stringliteral">"""</span>
<a name="l00537"></a><a class="code" href="classgraphics_1_1StringFunction_1_1StringFunction__v5.html#48ef6efe46111d597901a387fa12a824">00537</a> <span class="stringliteral">    Extension of class StringFunction_v4 to an arbitrary</span>
<a name="l00538"></a>00538 <span class="stringliteral">    number of independent variables.</span>
<a name="l00539"></a><a class="code" href="classgraphics_1_1StringFunction_1_1StringFunction__v5.html#3794e6061be839c8e60f59213eaa509b">00539</a> <span class="stringliteral">    """</span>
<a name="l00540"></a>00540     <span class="keyword">def </span><a class="code" href="classgraphics_1_1StringFunction_1_1StringFunction__v5.html#48ef6efe46111d597901a387fa12a824">__init__</a>(self, expression, **kwargs):
<a name="l00541"></a>00541         StringFunction_v4.__init__(self, expression, **kwargs)
<a name="l00542"></a>00542         self.<a class="code" href="classgraphics_1_1StringFunction_1_1StringFunction__v5.html#3794e6061be839c8e60f59213eaa509b">_var</a>_var = tuple(kwargs.get(<span class="stringliteral">'independent_variables'</span>, <span class="stringliteral">'x'</span>))
<a name="l00543"></a><a class="code" href="classgraphics_1_1StringFunction_1_1StringFunction__v5.html#a9457a957ac8c2d0ee3541c9f0ed4e63">00543</a>         <span class="keywordflow">try</span>:    del self._prms[<span class="stringliteral">'independent_variables'</span>]
<a name="l00544"></a>00544         <span class="keywordflow">except</span>: <span class="keywordflow">pass</span>
<a name="l00545"></a>00545         
<a name="l00546"></a>00546     <span class="keyword">def </span><a class="code" href="classgraphics_1_1StringFunction_1_1StringFunction__v5.html#a9457a957ac8c2d0ee3541c9f0ed4e63">__call__</a>(self, *args):
<a name="l00547"></a>00547         <span class="comment"># add independent variables to self._prms:</span>
<a name="l00548"></a>00548         <span class="keywordflow">for</span> name, value <span class="keywordflow">in</span> zip(self.<a class="code" href="classgraphics_1_1StringFunction_1_1StringFunction__v5.html#3794e6061be839c8e60f59213eaa509b">_var</a>_var, args):
<a name="l00549"></a><a class="code" href="classgraphics_1_1StringFunction_1_1StringFunction__v5.html#9b4f8e50658481b5b02ce383385d7353">00549</a>             self._prms[name] = value
<a name="l00550"></a>00550         <span class="keywordflow">return</span> eval(self._f_compiled, self._globals, self._prms)
<a name="l00551"></a>00551 
<a name="l00552"></a>00552     <span class="keyword">def </span><a class="code" href="classgraphics_1_1StringFunction_1_1StringFunction__v5.html#9b4f8e50658481b5b02ce383385d7353">__str__</a>(self):
<a name="l00553"></a>00553         <span class="comment"># remove the independent variables from self._prms such that</span>
<a name="l00554"></a>00554         <span class="comment"># this dict contains parameters (to be subsituted by values) only:</span>
<a name="l00555"></a>00555         <span class="keywordflow">try</span>:
<a name="l00556"></a>00556             <span class="keywordflow">for</span> v <span class="keywordflow">in</span> self.<a class="code" href="classgraphics_1_1StringFunction_1_1StringFunction__v5.html#3794e6061be839c8e60f59213eaa509b">_var</a>_var:
<a name="l00557"></a>00557                 del self._prms[v]
<a name="l00558"></a>00558         <span class="keywordflow">except</span>:
<a name="l00559"></a>00559             <span class="keywordflow">pass</span>
<a name="l00560"></a><a class="code" href="classgraphics_1_1StringFunction_1_1StringFunction__v5.html#7336834ebe2f788272d7026345ad0fe3">00560</a>         <span class="keywordflow">return</span> StringFunction1.__str__(self)
<a name="l00561"></a>00561     
<a name="l00562"></a>00562 
<a name="l00563"></a>00563     <span class="keyword">def </span><a class="code" href="classgraphics_1_1StringFunction_1_1StringFunction__v5.html#7336834ebe2f788272d7026345ad0fe3">__repr__</a>(self):
<a name="l00564"></a>00564         <span class="comment"># first remove indep. variables possibly inserted in self._prms</span>
<a name="l00565"></a>00565         <span class="comment"># by the self.__call__ method:</span>
<a name="l00566"></a>00566         <span class="keywordflow">try</span>:
<a name="l00567"></a>00567             <span class="keywordflow">for</span> v <span class="keywordflow">in</span> self.<a class="code" href="classgraphics_1_1StringFunction_1_1StringFunction__v5.html#3794e6061be839c8e60f59213eaa509b">_var</a>_var:
<a name="l00568"></a>00568                 del self._prms[v]
<a name="l00569"></a>00569         <span class="keywordflow">except</span>:
<a name="l00570"></a>00570             <span class="keywordflow">pass</span>
<a name="l00571"></a>00571         kwargs = <span class="stringliteral">', '</span>.join([<span class="stringliteral">'%s=%s'</span> % (key, repr(value)) \
<a name="l00572"></a>00572                             <span class="keywordflow">for</span> key, value <span class="keywordflow">in</span> self._prms.items()])
<a name="l00573"></a>00573         <span class="keywordflow">return</span> <span class="stringliteral">"""StringFunction(%s, independent_variables=%s, %s)"""</span> % \
<a name="l00574"></a>00574                (repr(self._f), repr(self.<a class="code" href="classgraphics_1_1StringFunction_1_1StringFunction__v5.html#3794e6061be839c8e60f59213eaa509b">_var</a>_var), kwargs)
<a name="l00575"></a>00575 
<a name="l00576"></a>00576 
<a name="l00577"></a>00577 
<a name="l00578"></a><a class="code" href="namespacegraphics_1_1StringFunction.html#8f918b45851e7c6e73d8de1ae2b656da">00578</a> <span class="keyword">def </span><a class="code" href="namespacegraphics_1_1StringFunction.html#8f918b45851e7c6e73d8de1ae2b656da">_efficiency</a>():
<a name="l00579"></a>00579     formula = <span class="stringliteral">'sin(x) + x**3 + 2*x'</span>
<a name="l00580"></a>00580     formula_wprm = formula + <span class="stringliteral">' + A*B'</span>
<a name="l00581"></a>00581     <span class="keyword">def </span>s0(x):
<a name="l00582"></a>00582         <span class="keywordflow">return</span> sin(x) + x**3 + 2*x
<a name="l00583"></a>00583     s1 = StringFunction_v1(formula)
<a name="l00584"></a>00584     s2 = StringFunction_v2(formula)  <span class="comment"># compiled</span>
<a name="l00585"></a>00585     s3 = StringFunction_v3(formula_wprm, set_parameters=<span class="stringliteral">'A=0; B=0'</span>)
<a name="l00586"></a>00586     s4 = StringFunction_v4(formula)
<a name="l00587"></a>00587     s5 = StringFunction_v5(formula, independent_variables=(<span class="stringliteral">'x'</span>,),
<a name="l00588"></a>00588                            A=0, B=0)
<a name="l00589"></a>00589     s6 = StringFunction(formula, independent_variables=(<span class="stringliteral">'x'</span>,),
<a name="l00590"></a>00590                         A=0, B=0)
<a name="l00591"></a>00591     s7 = s6.__call__
<a name="l00592"></a>00592     x = 0.9
<a name="l00593"></a>00593     <span class="comment"># verification first:</span>
<a name="l00594"></a>00594     values = [s(x) <span class="keywordflow">for</span> s <span class="keywordflow">in</span> s0, s1, s2, s3, s4, s5, s6, s7]
<a name="l00595"></a>00595     <span class="keywordflow">print</span> <span class="stringliteral">'values of %s for x=%s: %s'</span> % (formula, x, values)
<a name="l00596"></a>00596 
<a name="l00597"></a>00597     n = 400000
<a name="l00598"></a>00598     <span class="keyword">from</span> graphics.misc <span class="keyword">import</span> timer
<a name="l00599"></a>00599     <span class="keyword">from</span> graphics.EfficiencyTable <span class="keyword">import</span> EfficiencyTable <span class="keyword">as</span> ET
<a name="l00600"></a>00600     e = ET(<span class="stringliteral">'Efficiency check of StringFunction implementations; '</span>
<a name="l00601"></a>00601            <span class="stringliteral">'formula=%s, n=%d'</span> % (formula, n))
<a name="l00602"></a>00602     <span class="keyword">import</span> inspect
<a name="l00603"></a>00603     <span class="keywordflow">for</span> s <span class="keywordflow">in</span> s0, s1, s2, s3, s4, s5, s6, s7:
<a name="l00604"></a>00604         <span class="keywordflow">if</span> inspect.isfunction(s) <span class="keywordflow">or</span> inspect.ismethod(s):
<a name="l00605"></a>00605             name = s.__name__
<a name="l00606"></a>00606         <span class="keywordflow">else</span>:
<a name="l00607"></a>00607             name = s.__class__.__name__
<a name="l00608"></a>00608         t = timer(s, args=(x,), repetitions=100000,
<a name="l00609"></a>00609                   comment=name)
<a name="l00610"></a>00610         e.add(name, t)
<a name="l00611"></a>00611     <span class="keywordflow">print</span> e
<a name="l00612"></a>00612 
<a name="l00613"></a>00613 <span class="keywordflow">if</span> __name__ == <span class="stringliteral">'__main__'</span>:
<a name="l00614"></a>00614     _efficiency()
<a name="l00615"></a>00615     _demo()
<a name="l00616"></a>00616     _test()
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Fri Sep 28 18:29:16 2007 for graphics by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.5.1 </small></address>
</body>
</html>
